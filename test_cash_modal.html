<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Cash Payment Modal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }

        .modal {
            background: white;
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .modal-title {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .input-container {
            text-align: center;
            margin: 20px 0;
        }

        .code-input {
            font-size: 24px;
            text-align: center;
            width: 200px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            letter-spacing: 5px;
        }

        .virtual-keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 20px auto;
        }

        .key {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.2s;
        }

        .key:hover {
            background: #e9ecef;
        }

        .key:active {
            background: #dee2e6;
        }

        .control-key {
            background: #007bff;
            color: white;
        }

        .control-key:hover {
            background: #0056b3;
        }

        .modal-btn {
            width: 48%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px 1%;
        }

        .modal-btn-primary {
            background: #007bff;
            color: white;
        }

        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .debug-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="modal">
        <h3 class="modal-title">Cash Payment Test</h3>

        <div class="input-container">
            <input type="text" id="cashCode" class="code-input" placeholder="• • • • •" maxlength="5" readonly>
        </div>

        <div class="virtual-keyboard">
            <div class="key" onclick="addDigit('1')">1</div>
            <div class="key" onclick="addDigit('2')">2</div>
            <div class="key" onclick="addDigit('3')">3</div>
            <div class="key" onclick="addDigit('4')">4</div>
            <div class="key" onclick="addDigit('5')">5</div>
            <div class="key" onclick="addDigit('6')">6</div>
            <div class="key" onclick="addDigit('7')">7</div>
            <div class="key" onclick="addDigit('8')">8</div>
            <div class="key" onclick="addDigit('9')">9</div>
            <div class="key control-key" onclick="clearCashInput()">Clear</div>
            <div class="key" onclick="addDigit('0')">0</div>
            <div class="key control-key" onclick="quickFill()">67890</div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="modal-btn modal-btn-secondary" onclick="clearCashInput()">Batal</button>
            <button class="modal-btn modal-btn-primary" onclick="verifyCashCode()">Verifikasi</button>
        </div>

        <div class="debug-log" id="debugLog">
            <strong>Debug Log:</strong><br>
            Ready to test cash payment...<br>
        </div>
    </div>

    <script>
        function addDigit(digit) {
            const input = document.getElementById('cashCode');
            if (input.value.length < 5) {
                input.value += digit;
                logDebug(`Added digit: ${digit}, Current code: ${input.value}`);
            }
        }

        function clearCashInput() {
            document.getElementById('cashCode').value = '';
            logDebug('Code input cleared');
        }

        function quickFill() {
            document.getElementById('cashCode').value = '67890';
            logDebug('Quick filled with code: 67890');
        }

        function logDebug(message) {
            const log = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }

        async function verifyCashCode() {
            const code = document.getElementById('cashCode').value;

            logDebug(`Starting verification for code: ${code}`);

            if (code.length < 5) {
                alert('Silakan masukkan 5 digit kode cash!');
                logDebug('ERROR: Code length < 5');
                return;
            }

            try {
                // First test: Check if API is reachable
                logDebug(`Testing API connectivity...`);

                const testResponse = await fetch('/FotoboxJO/src/api-fetch/test_api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test: 'connectivity',
                        code: code
                    })
                });

                const testResult = await testResponse.json();
                logDebug(`Test API Response: ${JSON.stringify(testResult)}`);

                // Now test the actual verification
                logDebug(`Calling verify API: /FotoboxJO/src/api-fetch/verify_cash_code.php`);

                const response = await fetch('/FotoboxJO/src/api-fetch/verify_cash_code.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code
                    })
                });

                logDebug(`API Response status: ${response.status}`);
                logDebug(`API Response ok: ${response.ok}`);

                const responseText = await response.text();
                logDebug(`Raw response: ${responseText}`);

                let result;
                try {
                    result = JSON.parse(responseText);
                    logDebug(`Parsed JSON: ${JSON.stringify(result, null, 2)}`);
                } catch (parseError) {
                    logDebug(`JSON Parse Error: ${parseError.message}`);
                    alert('Server response tidak valid (bukan JSON): ' + responseText);
                    return;
                }

                if (result.success) {
                    logDebug(`SUCCESS: ${result.message}`);
                    alert(`✅ ${result.message}\nKode: ${result.code}\nDigunakan: ${result.used_at}`);

                    // Test session API call
                    logDebug('Testing session API...');
                    const sessionResponse = await fetch('/FotoboxJO/src/api-fetch/set_session.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'start_cash_session'
                        })
                    });

                    const sessionResult = await sessionResponse.json();
                    logDebug(`Session result: ${JSON.stringify(sessionResult)}`);

                    if (sessionResult.success) {
                        alert('✅ Sesi cash berhasil dimulai!');
                        logDebug('Cash session started successfully');
                    } else {
                        alert('❌ Gagal memulai sesi cash');
                        logDebug('Failed to start cash session');
                    }
                } else {
                    logDebug(`FAILED: ${result.message}`);
                    alert(`❌ ${result.message}`);
                    clearCashInput();
                }
            } catch (error) {
                logDebug(`CATCH ERROR: ${error.message}`);
                logDebug(`Error stack: ${error.stack}`);
                console.error('Error verifying cash code:', error);
                alert('Terjadi kesalahan jaringan. Silakan coba lagi.');
            }
        }

        // Auto-focus dan log status
        window.addEventListener('load', function () {
            logDebug('Page loaded, ready for testing');
            logDebug(`Current URL: ${window.location.href}`);
        });
    </script>
</body>

</html>