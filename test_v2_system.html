<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test New File-Based Token System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .success { border-left: 4px solid #4CAF50; }
        .info { border-left: 4px solid #2196F3; }
        .warning { border-left: 4px solid #FF9800; }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        .result { margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 4px; }
        .token-info { 
            background: #e3f2fd; 
            border: 1px solid #2196F3; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="test-box info">
        <h1>üîß Test New File-Based Token System</h1>
        <p>Sistem baru menggunakan file metadata (.meta) untuk menyimpan informasi token, tidak bergantung pada session PHP.</p>
    </div>

    <div class="test-box warning">
        <h3>‚ö†Ô∏è Current Problem</h3>
        <p><strong>Token yang bermasalah:</strong> <code>8956ba2a5fa88a1b5f7f8be1101f5ba7</code></p>
        <p>Token ini kemungkinan dibuat dengan sistem lama (session-based) dan sekarang session hilang.</p>
    </div>

    <div class="test-box">
        <h3>üß™ Test 1: Create New Token with V2 System</h3>
        <button onclick="testNewSystem()">Create Test Photo with V2 API</button>
        <div id="newSystemResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-box">
        <h3>üîç Test 2: Check Existing Token</h3>
        <button onclick="checkExistingToken()">Check Token: 8956ba2a5fa88a1b5f7f8be1101f5ba7</button>
        <div id="existingTokenResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-box">
        <h3>üìÅ Test 3: File System Analysis</h3>
        <button onclick="analyzeFileSystem()">Analyze Photo Directory</button>
        <div id="fileSystemResult" class="result" style="display:none;"></div>
    </div>

    <script>
        async function testNewSystem() {
            try {
                const resultDiv = document.getElementById('newSystemResult');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<div style="color: blue;">üîÑ Creating test photo with V2 system...</div>';

                // Create a test canvas
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                // Draw test content
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(0, 0, 400, 300);
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('FILE-BASED SYSTEM TEST', 200, 140);
                ctx.fillText('V2 API', 200, 170);
                ctx.fillText(new Date().toLocaleString('id-ID', {timeZone: 'Asia/Makassar'}), 200, 200);
                
                const imageData = canvas.toDataURL('image/png');
                
                const response = await fetch('/src/api-fetch/save_final_photo_v2.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageData
                    })
                });
                
                const result = await response.text();
                console.log('V2 API response:', result);
                
                const data = JSON.parse(result);
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="color: green;">
                            <strong>‚úÖ V2 SYSTEM SUCCESS!</strong><br>
                            <div class="token-info">
                                <strong>Token:</strong> ${data.token}<br>
                                <strong>URL:</strong> <a href="${data.url}" target="_blank">${data.url}</a><br>
                                <strong>Expires:</strong> ${data.expires_at} (Waktu Makassar)<br>
                                <strong>Storage:</strong> ${data.storage_method}<br>
                            </div>
                            <a href="${data.url}" target="_blank" style="background: #2196F3; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px;">
                                üîó Test V2 Link
                            </a>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div style="color: red;"><strong>‚ùå ERROR:</strong> ${data.error}</div>`;
                }
                
            } catch (error) {
                console.error('Error:', error);
                const resultDiv = document.getElementById('newSystemResult');
                resultDiv.innerHTML = `<div style="color: red;"><strong>‚ùå ERROR:</strong> ${error.message}</div>`;
            }
        }

        async function checkExistingToken() {
            const resultDiv = document.getElementById('existingTokenResult');
            resultDiv.style.display = 'block';
            
            const token = '8956ba2a5fa88a1b5f7f8be1101f5ba7';
            
            try {
                const response = await fetch('/hunt_token.php');
                const html = await response.text();
                
                resultDiv.innerHTML = `
                    <div style="color: blue;">
                        <strong>üîç Token Hunt Result:</strong><br>
                        <iframe src="/hunt_token.php" style="width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 4px;"></iframe>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: red;"><strong>‚ùå ERROR:</strong> ${error.message}</div>`;
            }
        }

        async function analyzeFileSystem() {
            const resultDiv = document.getElementById('fileSystemResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="color: blue;">üîÑ Analyzing file system...</div>';
            
            try {
                // Open the debug session page in iframe
                resultDiv.innerHTML = `
                    <div style="color: blue;">
                        <strong>üìÅ File System Analysis:</strong><br>
                        <iframe src="/debug_session.php?reload=1" style="width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 4px;"></iframe>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: red;"><strong>‚ùå ERROR:</strong> ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
