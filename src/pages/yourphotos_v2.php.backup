<?php
// Set timezone to Makassar (WITA)
date_default_timezone_set('Asia/Makassar');

session_start();

$token = $_GET['token'] ?? '';

// NEW: File-based token validation (more reliable)
function validateTokenFromFile($token) {
    $photoDir = '/tmp/photobooth-photos';
    $metaFile = "{$photoDir}/{$token}.meta";
    $imageFile = "{$photoDir}/{$token}.png";
    
    // Check if metadata file exists
    if (!file_exists($metaFile)) {
        return ['valid' => false, 'reason' => 'Token metadata not found'];
    }
    
    // Read metadata
    $metaContent = file_get_contents($metaFile);
    $metadata = json_decode($metaContent, true);
    
    if (!$metadata) {
        return ['valid' => false, 'reason' => 'Invalid metadata format'];
    }
    
    // Check if expired
    if (time() > $metadata['expire']) {
        return ['valid' => false, 'reason' => 'Token expired', 'metadata' => $metadata];
    }
    
    // Check if image file exists
    if (!file_exists($imageFile)) {
        return ['valid' => false, 'reason' => 'Image file not found'];
    }
    
    return ['valid' => true, 'metadata' => $metadata, 'filename' => $imageFile];
}

// Check token validity
$validation = validateTokenFromFile($token);
$expired_or_invalid = !$validation['valid'];

if (!$expired_or_invalid) {
    $filename = $validation['filename'];
    $metadata = $validation['metadata'];
}

// OLD: Session-based fallback (for backward compatibility)
if ($expired_or_invalid && isset($_SESSION['photo_tokens'][$token])) {
    $photoData = $_SESSION['photo_tokens'][$token];
    if (time() <= $photoData['expire'] && file_exists($photoData['filename'])) {
        $expired_or_invalid = false;
        $filename = $photoData['filename'];
        $metadata = $photoData;
    }
}

// Clean up expired tokens (both file and session based)
function cleanupExpiredTokens() {
    $photoDir = '/tmp/photobooth-photos';
    
    if (is_dir($photoDir)) {
        $files = glob("{$photoDir}/*.meta");
        foreach ($files as $metaFile) {
            $metaContent = file_get_contents($metaFile);
            $metadata = json_decode($metaContent, true);
            
            if ($metadata && time() > $metadata['expire']) {
                $token = $metadata['token'];
                $imageFile = "{$photoDir}/{$token}.png";
                
                // Delete expired files
                @unlink($metaFile);
                @unlink($imageFile);
            }
        }
    }
    
    // Clean session tokens too
    if (isset($_SESSION['photo_tokens'])) {
        foreach ($_SESSION['photo_tokens'] as $key => $data) {
            if (time() > $data['expire']) {
                if (file_exists($data['filename'])) {
                    @unlink($data['filename']);
                }
                unset($_SESSION['photo_tokens'][$key]);
            }
        }
    }
}

cleanupExpiredTokens();
?>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Photo - Photobooth</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Syne:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .success-icon {
            color: #4CAF50;
        }

        .error-icon {
            color: #f44336;
        }

        h1 {
            font-family: 'Syne', sans-serif;
            font-size: 2rem;
            margin-bottom: 15px;
            color: #333;
        }

        .success-title {
            color: #4CAF50;
        }

        .error-title {
            color: #f44336;
        }

        .message {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .photo-container {
            margin: 30px 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .photo-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .download-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .back-btn {
            background: #666;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #555;
            transform: translateY(-1px);
        }

        .expire-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
            font-size: 0.9rem;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            font-family: monospace;
            font-size: 0.8rem;
            color: #6c757d;
        }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .message {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <?php if ($expired_or_invalid): ?>
            <div class="icon error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h1 class="error-title">Link Expired atau Tidak Valid</h1>
            <p class="message">
                Maaf, link foto ini sudah tidak berlaku atau tidak ditemukan.<br>
                Link foto hanya berlaku selama 30 menit untuk menjaga privasi Anda.
            </p>
            
            <?php if (isset($validation) && $validation['reason']): ?>
                <div class="debug-info">
                    <strong>Debug Info:</strong><br>
                    Reason: <?php echo htmlspecialchars($validation['reason']); ?><br>
                    Token: <?php echo htmlspecialchars($token); ?><br>
                    Current Time: <?php echo date('Y-m-d H:i:s'); ?><br>
                    Timezone: <?php echo date_default_timezone_get(); ?><br>
                    
                    <?php if (isset($validation['metadata'])): ?>
                        <br><strong>Token Metadata:</strong><br>
                        Created: <?php echo date('Y-m-d H:i:s', $validation['metadata']['created']); ?><br>
                        Expires: <?php echo date('Y-m-d H:i:s', $validation['metadata']['expire']); ?><br>
                        Timezone: <?php echo $validation['metadata']['timezone'] ?? 'Unknown'; ?><br>
                    <?php endif; ?>
                </div>
            <?php endif; ?>
            
        <?php else: ?>
            <div class="icon success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h1 class="success-title">Foto Anda Siap!</h1>
            <p class="message">
                Foto hasil photobooth Anda berhasil disimpan. Silakan download sebelum link expired.
            </p>
            
            <div class="photo-container">
                <img src="data:image/png;base64,<?php echo base64_encode(file_get_contents($filename)); ?>" alt="Your Photo">
            </div>
            
            <a href="data:image/png;base64,<?php echo base64_encode(file_get_contents($filename)); ?>" 
               download="photobooth-<?php echo date('Y-m-d-H-i-s'); ?>.png" 
               class="download-btn">
                <i class="fas fa-download"></i>
                Download Foto
            </a>
            
            <div class="expire-info">
                <i class="fas fa-clock"></i>
                Link ini akan expired pada: <strong><?php echo date('Y-m-d H:i:s', $metadata['expire']); ?></strong> (Waktu Makassar)
            </div>
        <?php endif; ?>
        
        <!-- <a href="/" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Kembali ke Photobooth
        </a> -->
    </div>
    <!-- Global Fullscreen Handler -->
    <script src="/src/includes/fullscreen-handler.js"></script>
</body>
</html>
